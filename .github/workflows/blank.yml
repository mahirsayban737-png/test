name: RDP with Ngrok

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 # 6 hours

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          # Create a secure, random password
          $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 20 | ForEach-Object {[char]$_})
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Create and configure the user
          New-LocalUser "RDP" -Password $securePass -FullName "RDP User" -Description "Temporary RDP user"
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          
          # Save credentials to environment variables for the next steps
          echo "RDP_USER=RDP" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          Write-Host "RDP user 'RDP' created."

      - name: Install and Configure Ngrok
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          # Download and install Ngrok
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive ngrok.zip -DestinationPath "C:\ngrok"
          
          # Add Ngrok to the system's PATH
          $env:Path += ";C:\ngrok"
          echo "C:\ngrok" >> $env:GITHUB_PATH

          # Authenticate Ngrok using the secret
          ngrok config add-authtoken $env:NGROK_AUTHTOKEN
          Write-Host "Ngrok installed and authenticated."
          
      - name: Start Ngrok RDP Tunnel
        run: |
          # Start the dedicated RDP tunnel in the background. Ngrok handles the port automatically.
          Start-Process ngrok -ArgumentList "rdp --log=stdout" -NoNewWindow
          
          # Wait for Ngrok API to be available and get the tunnel details
          $ngrokHostname = $null
          $retries = 0
          while (-not $ngrokHostname -and $retries -lt 15) {
              Write-Host "Waiting for Ngrok tunnel... (Attempt $($retries+1)/15)"
              Start-Sleep -Seconds 4
              try {
                  # Query the local Ngrok API for active tunnels
                  $tunnels = (Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels").tunnels
                  $rdpTunnel = $tunnels | Where-Object { $_.proto -eq 'rdp' }
                  if ($rdpTunnel) {
                      # The public URL will be like 'rdp://0.rdp.ngrok.io'
                      # We just need the hostname part.
                      $ngrokHostname = ($rdpTunnel.public_url -replace 'rdp://', '')
                  }
              } catch {
                  Write-Warning "Ngrok API not ready. Retrying..."
              }
              $retries++
          }
          
          if (-not $ngrokHostname) {
              Write-Error "Failed to get Ngrok RDP tunnel URL. Check Ngrok status."
              exit 1
          }
          
          echo "NGROK_HOSTNAME=$ngrokHostname" >> $env:GITHUB_ENV
          Write-Host "Ngrok RDP tunnel established at: $ngrokHostname"

      - name: Display Connection Details and Maintain Connection
        run: |
          Write-Host "`n"
          Write-Host "==================== RDP ACCESS DETAILS ===================="
          Write-Host "Please connect using the following details:"
          Write-Host ""
          Write-Host "   Address:   $($env:NGROK_HOSTNAME)"
          Write-Host "   Username:  $($env:RDP_USER)"
          Write-Host "   Password:  $($env:RDP_PASSWORD)"
          Write-Host ""
          Write-Host "Note: The RDP port (3389) is handled automatically by Ngrok."
          Write-Host "============================================================"
          Write-Host "`n"
          Write-Host "Workflow is active. It will timeout in 6 hours or you can manually cancel it."
          
          # Keep the runner active to maintain the RDP session
          while ($true) {
              Start-Sleep -Seconds 300
          }
