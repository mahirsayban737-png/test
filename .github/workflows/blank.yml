name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing firewall rule to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Ngrok" 2>$null
          
          # Allow incoming connections on port 3389
          netsh advfirewall firewall add rule name="RDP-Ngrok" `
            dir=in action=allow protocol=TCP localport=3389

          # Restart the Remote Desktop service
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        run: |
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)      # A-Z
              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126))
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name "RDP")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install ngrok
        run: |
          $ngrokUrl = "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip"
          $zipPath = "$env:TEMP\ngrok.zip"
          $extractPath = "$env:TEMP\ngrok"
          
          Invoke-WebRequest -Uri $ngrokUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          
          # Move ngrok to permanent location
          $ngrokDir = "C:\ngrok"
          New-Item -ItemType Directory -Path $ngrokDir -Force
          Move-Item -Path "$extractPath\ngrok.exe" -Destination "$ngrokDir\ngrok.exe" -Force
          
          # Clean up
          Remove-Item $zipPath -Force
          Remove-Item $extractPath -Recurse -Force

      - name: Configure and Start ngrok Tunnel
        run: |
          # Authenticate ngrok
          & "C:\ngrok\ngrok.exe" config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }}
          
          # Start ngrok TCP tunnel for RDP (port 3389) in background
          Start-Process -FilePath "C:\ngrok\ngrok.exe" -ArgumentList "tcp", "3389", "--log", "C:\ngrok\ngrok.log" -WindowStyle Hidden
          
          # Wait for ngrok to initialize
          Start-Sleep -Seconds 10
          
          # Get tunnel information from ngrok local API
          $maxRetries = 12
          $retryCount = 0
          $tunnelInfo = $null
          
          while ($retryCount -lt $maxRetries) {
              try {
                  $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -Method Get
                  if ($response.tunnels -and $response.tunnels.Count -gt 0) {
                      $tunnelInfo = $response.tunnels[0]
                      break
                  }
              } catch {
                  Write-Host "Waiting for ngrok tunnel... (attempt $($retryCount + 1)/$maxRetries)"
              }
              Start-Sleep -Seconds 5
              $retryCount++
          }
          
          if (-not $tunnelInfo) {
              Write-Error "Failed to get ngrok tunnel information"
              Write-Host "ngrok log contents:"
              Get-Content "C:\ngrok\ngrok.log" -ErrorAction SilentlyContinue
              exit 1
          }
          
          # Extract connection details
          $publicUrl = $tunnelInfo.public_url
          echo "NGROK_URL=$publicUrl" >> $env:GITHUB_ENV
          
          # Parse host and port
          if ($publicUrl -match "tcp://([^:]+):(\d+)") {
              $ngrokHost = $matches[1]
              $ngrokPort = $matches[2]
              echo "NGROK_HOST=$ngrokHost" >> $env:GITHUB_ENV
              echo "NGROK_PORT=$ngrokPort" >> $env:GITHUB_ENV
              
              Write-Host "ngrok tunnel established: $publicUrl"
              Write-Host "Host: $ngrokHost"
              Write-Host "Port: $ngrokPort"
          } else {
              Write-Error "Failed to parse ngrok URL"
              exit 1
          }

      - name: Resolve ngrok IP and Update No-IP
        run: |
          # Resolve the ngrok hostname to an IP address
          Write-Host "Resolving ngrok hostname: $env:NGROK_HOST"
          
          try {
              $resolvedIP = [System.Net.Dns]::GetHostAddresses($env:NGROK_HOST) | 
                            Where-Object { $_.AddressFamily -eq 'InterNetwork' } | 
                            Select-Object -First 1 -ExpandProperty IPAddressToString
              
              if (-not $resolvedIP) {
                  Write-Error "Failed to resolve ngrok hostname to IPv4 address"
                  exit 1
              }
              
              Write-Host "Resolved ngrok IP: $resolvedIP"
              echo "NGROK_IP=$resolvedIP" >> $env:GITHUB_ENV
              
          } catch {
              Write-Error "DNS resolution failed: $_"
              exit 1
          }
          
          # Update No-IP with the ngrok IP
          Write-Host "`nUpdating No-IP hostname: ${{ secrets.NOIP_HOSTNAME }}"
          
          $noipUser = "${{ secrets.NOIP_USERNAME }}"
          $noipPass = "${{ secrets.NOIP_PASSWORD }}"
          $noipHostname = "${{ secrets.NOIP_HOSTNAME }}"
          
          # Create Base64 encoded credentials
          $credentials = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${noipUser}:${noipPass}"))
          
          # No-IP Update URL
          $updateUrl = "https://dynupdate.no-ip.com/nic/update?hostname=$noipHostname&myip=$resolvedIP"
          
          try {
              $headers = @{
                  "Authorization" = "Basic $credentials"
                  "User-Agent" = "GitHub Actions No-IP Updater/1.0"
              }
              
              $response = Invoke-WebRequest -Uri $updateUrl -Headers $headers -Method Get -UseBasicParsing
              $responseText = $response.Content.Trim()
              
              Write-Host "No-IP Update Response: $responseText"
              
              if ($responseText -match "^(good|nochg)") {
                  Write-Host "✓ No-IP hostname updated successfully!"
                  echo "NOIP_STATUS=success" >> $env:GITHUB_ENV
              } else {
                  Write-Warning "No-IP update returned unexpected response: $responseText"
                  echo "NOIP_STATUS=warning" >> $env:GITHUB_ENV
              }
              
          } catch {
              Write-Error "Failed to update No-IP: $_"
              echo "NOIP_STATUS=failed" >> $env:GITHUB_ENV
          }
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "ngrok URL: $env:NGROK_URL"
          Write-Host "ngrok IP: $env:NGROK_IP"
          
          # Test local RDP connectivity
          $testResult = Test-NetConnection -ComputerName localhost -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "Local TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "Local RDP connectivity verified!"

      - name: Display Connection Info and Maintain Connection
        run: |
          Write-Host "`n╔════════════════════════════════════════════════════════╗"
          Write-Host "║              RDP CONNECTION DETAILS                    ║"
          Write-Host "╠════════════════════════════════════════════════════════╣"
          Write-Host "║ OPTION 1: Connect via ngrok URL (Recommended)          ║"
          Write-Host "║ Host:     $env:NGROK_HOST"
          Write-Host "║ Port:     $env:NGROK_PORT"
          Write-Host "║                                                        ║"
          Write-Host "║ OPTION 2: Connect via No-IP hostname                   ║"
          Write-Host "║ Host:     ${{ secrets.NOIP_HOSTNAME }}"
          Write-Host "║ Port:     $env:NGROK_PORT"
          Write-Host "║ (Note: Port still needs to be specified!)             ║"
          Write-Host "║                                                        ║"
          Write-Host "║ Username: RDP                                          ║"
          Write-Host "║ Password: $env:RDP_PASSWORD"
          Write-Host "╠════════════════════════════════════════════════════════╣"
          Write-Host "║ ngrok IP: $env:NGROK_IP"
          Write-Host "║ No-IP Update Status: $env:NOIP_STATUS"
          Write-Host "╚════════════════════════════════════════════════════════╝`n"
          
          Write-Host "Connect using:"
          Write-Host "  mstsc /v:$env:NGROK_HOST`:$env:NGROK_PORT"
          Write-Host "    OR"
          Write-Host "  mstsc /v:${{ secrets.NOIP_HOSTNAME }}`:$env:NGROK_PORT`n"
          
          # Keep runner active
          $startTime = Get-Date
          while ($true) {
              $elapsed = (Get-Date) - $startTime
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP Active for $([math]::Floor($elapsed.TotalMinutes)) minutes - Ctrl+C to terminate"
              
              # Verify ngrok process is still running
              $ngrokProcess = Get-Process -Name ngrok -ErrorAction SilentlyContinue
              if (-not $ngrokProcess) {
                  Write-Error "ngrok process terminated unexpectedly!"
                  Get-Content "C:\ngrok\ngrok.log" -Tail 50
                  exit 1
              }
              
              Start-Sleep -Seconds 300
          }
